services:
  - name: clamav-freshclam
    nodes:
      - localhost
  - name: catboard
    nodes:
      - 172.16.100.177
      - 172.16.100.99
      - 172.16.100.101
    unit: |
      [Unit]
      Description=Catboard port 7777
      [Service]
      Environment=CATBOARD_SQLALCHEMY_DATABASE_URI=postgresql://postgres:tKmLiIeBBXxXwzVg1W6S@172.16.100.101:5432/postgres
      WorkingDirectory=/root/catboard
      ExecStart=/root/catboard/env/bin/python /root/catboard/app.py --host 0.0.0.0 --port 7777
    ports:
      - 7777
    deploy: |
      apt update
      apt install -y python3-pip python3-venv git
      rm -rf /root/catboard
      git clone https://github.com/dvolk/catboard /root/catboard
      cd /root/catboard
      python3 -m venv env
      source /root/catboard/env/bin/activate
      pip3 install -r requirements.txt
      CATBOARD_SQLALCHEMY_DATABASE_URI=postgresql://postgres:tKmLiIeBBXxXwzVg1W6S@172.16.100.101:5432/postgres flask db upgrade
    delete: |
      rm -rf /root/catboard
  - name: docker.postgres
    nodes:
      - 172.16.100.101
    unit: |
      [Unit]
      After=docker.service
      Requires=docker.service
      [Service]
      TimeoutStartSec=0
      Restart=always
      ExecStartPre=-/usr/bin/docker stop %n
      ExecStartPre=-/usr/bin/docker rm %n
      ExecStartPre=/usr/bin/docker pull postgres
      ExecStart=/usr/bin/docker run -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=tKmLiIeBBXxXwzVg1W6S --rm --name %n postgres
      [Install]
      WantedBy=multi-user.target
    deploy: |
      apt update
      apt install -y docker.io
    delete: |
      docker stop postgres
      docker rm postgres
